<template>
  <div id="app">
    <div v-if="!isConnected" class="slide-up-panel">
      <input type="text" v-model="room" placeholder="Enter User Name" />
      <div class="roles">
        <div :class="userName == 'human' ? 'li-c' : 'li'" @click="setName('human')">
          <svg t="1718890532044" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5608" width="55"><path d="M511.5 478.3c-63.3 0-122.9-24.7-167.7-69.5-44.8-44.8-69.5-104.4-69.5-167.7S299 118.3 343.8 73.5 448.2 4 511.5 4c63.3 0 122.9 24.7 167.7 69.5 44.8 44.8 69.5 104.4 69.5 167.7S724 364.1 679.2 408.9c-44.8 44.8-104.4 69.4-167.7 69.4z m0-394.3c-86.7 0-157.2 70.5-157.2 157.2s70.5 157.2 157.2 157.2c86.7 0 157.2-70.5 157.2-157.2S598.2 84 511.5 84zM880.6 1024c-22.1 0-40-17.9-40-40V777.2c0-84.1-65.3-153.3-147.9-159.5l-93.5 66.6c-52.1 37.1-122.1 37.2-174.3 0.3l-94.6-66.9c-82.6 6.2-147.9 75.4-147.9 159.5V984c0 22.1-17.9 40-40 40s-40-17.9-40-40V777.2c0-64.1 25-124.4 70.3-169.7 45.3-45.3 105.6-70.3 169.7-70.3 8.3 0 16.3 2.6 23.1 7.3l105.6 74.7c24.5 17.3 57.3 17.2 81.7-0.1l104.6-74.5c6.8-4.8 14.9-7.4 23.2-7.4 64.1 0 124.4 25 169.7 70.3 45.3 45.3 70.3 105.6 70.3 169.7V984c0 22.1-17.9 40-40 40z" fill="" p-id="5609"></path><path d="M282 1024c-22.1 0-40-17.9-40-40v-96c0-22.1 17.9-40 40-40s40 17.9 40 40v96c0 22.1-17.9 40-40 40zM741 1024c-22.1 0-40-17.9-40-40v-96c0-22.1 17.9-40 40-40s40 17.9 40 40v96c0 22.1-17.9 40-40 40zM692 244.6H167c-22.1 0-40-17.9-40-40s17.9-40 40-40h525c22.1 0 40 17.9 40 40s-17.9 40-40 40z" fill="" p-id="5610"></path></svg>
        </div>
        <div :class="userName == 'puppy' ? 'li-c' : 'li'" @click="setName('puppy')">
          <svg t="1718890472169" class="icon" viewBox="0 0 1030 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1835" width="63"><path d="M1023.434567 373.186085v84.815019c-2.827167 1.6963-6.785202 2.827167-7.916069 5.654335-20.921038 41.842076-51.454445 70.113749-99.516289 78.595251-5.654335 1.130867-13.00497 16.963004-13.00497 26.009939 0 15.266703 6.219768 31.09884 7.916069 46.365544 9.612369 91.034787-3.958034 176.41524-70.679183 244.83269-71.81005 73.50635-166.802871 92.165654-264.057427 98.385422-57.10878 3.958034-114.782993 2.261734-171.326339-6.219768-50.323578-7.350635-101.778023-19.790171-147.0127-41.842076-101.21259-50.323578-144.750966-139.096632-142.489233-250.487024 0.565433-27.70624 5.654335-55.412479 9.612369-83.118719 2.827167-19.224738 3.958034-32.795141-23.182772-37.884042-20.355605-3.392601-40.145776-18.093871-56.543346-32.229707-15.266703-13.00497-26.575373-31.664274-39.580342-48.061845V373.186085c3.958034-4.523468 10.177802-7.916068 12.439536-13.00497C45.234677 286.674765 90.469354 225.607951 146.447267 172.457206c50.889012-48.627278 108.563225-83.118719 183.765875-53.150745 5.088901 2.261734 14.135837-2.261734 20.355605-5.088902 109.694092-61.066814 218.82275-61.066814 327.951408 0 6.785202 3.392601 16.39757 6.785202 22.617338 4.523468 57.10878-22.617338 106.301491-6.219768 150.970734 28.837107 71.244616 55.412479 123.264495 126.657096 157.755936 210.341248 2.827167 5.654335 9.046935 10.177802 13.570404 15.266703z m-476.660409 525.287686c51.454445-9.046935 98.950856-14.135837 144.185533-25.444505 76.333517-19.224738 132.876864-62.763114 152.101601-143.6201 15.266703-62.763114 6.785202-125.526229-11.874103-184.896742-26.575373-83.684152-55.977913-166.237438-89.90392-247.094423-34.491441-82.553285-85.945886-147.0127-185.462176-159.452236-114.217559-14.70127-204.12148 22.617338-251.052457 123.829928-55.977913 122.133628-111.955826 247.094423-124.395362 383.363887-8.481502 91.600221 20.921038 173.588073 120.437328 215.430149 57.674213 24.313639 117.61016 31.664274 182.069575 31.664274 0-32.795141-1.130867-65.590282 0.565433-98.385422 1.130867-17.528437-5.654335-28.271673-19.790171-36.187742-28.837107-16.963004-50.889012-40.145776-66.155715-70.113749-24.313639-49.758145-8.481502-97.819989 44.669243-111.955826 50.889012-13.570403 104.039757-15.832137 154.928769 3.958035 33.360574 13.00497 48.061844 37.884042 44.669244 72.940916-3.392601 36.187742-24.313639 63.328548-51.454445 86.51132-14.70127 12.439536-39.580342 23.182772-41.842077 37.884042-5.654335 37.884042-1.6963 77.464384-1.6963 121.568194zM283.847598 177.546107l-5.088901-8.481502c-20.921038 9.046935-44.669244 14.70127-62.763114 28.271673-64.459415 48.627278-111.390392 112.521259-139.662066 188.854777-15.266703 40.145776-3.392601 85.380453 48.061845 93.861954 19.224738 3.392601 26.009939 0.565433 32.79514-16.963003 37.884042-97.254555 62.763114-200.163446 126.657096-285.543899z m465.917173-3.392601c22.051905 45.234677 45.234677 87.076753 63.328548 130.61513 22.051905 52.585312 39.580342 106.866924 61.066814 159.452236 2.827167 7.916068 15.266703 17.528437 22.617338 16.963004 48.627278-5.088901 75.20265-41.842076 59.935947-87.642186-24.879072-74.071784-71.244616-135.138597-129.484263-186.593043-22.617338-19.224738-46.930977-36.187742-77.464384-32.795141z m-299.679735 461.959139c6.219768 38.449475 42.40751 74.637217 66.721148 72.940917 23.748205-1.6963 58.239647-40.145776 61.066814-72.940917H450.085036z" fill="" p-id="1836"></path><path d="M5.654335 458.001104c13.00497 16.39757 23.748205 35.056875 39.580342 48.061845 16.963004 14.135837 36.753175 28.837107 57.10878 32.79514 27.140806 5.088901 25.444506 18.659304 23.182772 37.884042-3.958034 27.70624-9.046935 55.412479-9.612369 83.118719-1.6963 111.390392 41.276643 200.163446 142.489232 250.487024 45.234677 22.051905 96.689122 34.491441 147.0127 41.842076 56.543346 7.916068 114.217559 9.612369 171.326339 6.219768 96.689122-6.219768 191.681944-24.313639 264.057427-98.385422 66.721149-68.417449 80.291552-153.797902 70.679183-244.832689-1.6963-15.832137-7.916068-31.09884-7.916068-46.365544 0-9.046935 6.785202-24.879072 13.004969-26.009939 48.061844-8.481502 78.595251-36.753175 99.51629-78.595252 1.130867-2.827167 5.088901-3.958034 7.916068-5.654334v565.433462H6.219768C5.654335 835.145224 5.654335 646.290447 5.654335 458.001104zM1023.434567 373.186085c-4.523468-5.088901-10.743236-9.612369-13.00497-15.832137-34.491441-83.684152-86.51132-154.363335-157.755936-210.341248-45.234677-35.056875-94.427388-51.454445-150.970734-28.837106-6.219768 2.261734-16.39757-0.565433-22.617339-4.523468-109.694092-61.066814-218.82275-61.066814-327.951408 0-6.219768 3.392601-14.70127 7.350635-20.355605 5.088901-75.20265-30.533407-132.876864 3.958034-183.765875 53.150746C90.469354 225.607951 45.234677 286.674765 18.093871 360.181115c-2.261734 5.088901-8.481502 8.481502-12.439536 13.00497V6.219768h1017.780232V373.186085z" fill="#FFFFFF" p-id="1837"></path><path d="M546.774158 898.473771c0-43.538377-3.958034-83.684152 2.261734-121.568194 2.261734-14.135837 27.140806-25.444506 41.842076-37.884042 27.140806-23.182772 48.061844-50.323578 51.454445-86.51132 3.392601-35.622308-11.874103-60.50138-44.669243-72.940916-50.889012-19.790171-104.039757-17.528437-154.928769-3.958035-53.150745 14.135837-68.982882 62.197681-44.669244 111.955826 14.70127 29.967973 36.753175 53.716179 66.155715 70.113749 14.135837 7.916068 20.921038 18.659304 19.790172 36.187742-1.6963 32.795141-0.565433 65.590282-0.565434 98.385422-64.459415 0-124.960795-7.350635-182.069575-31.664274-99.516289-41.842076-129.484263-124.395362-120.437327-215.430149C192.812811 508.890116 248.790723 383.929321 305.33407 261.23026c46.930977-101.21259 136.834898-138.531198 251.052457-123.829929 98.950856 12.439536 150.970734 76.898951 185.462175 159.452237 33.360574 80.856985 63.328548 163.410271 89.903921 247.094423 18.659304 59.935947 27.140806 122.133628 11.874103 184.896742-19.224738 80.856985-75.768084 124.395362-152.101602 143.620099-46.365544 11.874103-93.861955 16.963004-144.750966 26.009939z m112.521259-453.477636c0.565433-22.617338-19.224738-43.538377-40.711209-44.10381-18.659304-0.565433-41.842076 21.486472-43.538377 40.145775-1.6963 21.486472 19.224738 41.842076 42.40751 42.40751 22.051905 1.130867 41.276643-16.39757 41.842076-38.449475z m-248.22529 39.014909c24.313639-0.565433 39.580342-16.963004 39.014909-41.276643-0.565433-24.879072-16.39757-40.145776-40.711209-40.145776-22.617338 0-39.580342 18.093871-39.580343 41.842076 0.565433 22.051905 19.224738 40.145776 41.276643 39.580343zM283.847598 177.546107C219.953617 262.92656 195.074544 365.83545 157.190502 462.524572c-6.785202 18.093871-13.570403 20.355605-32.79514 16.963004-51.454445-9.046935-63.328548-53.716179-48.061845-93.861955 28.271673-75.768084 75.20265-139.662065 139.662066-188.854776 18.093871-13.570403 41.842076-19.224738 62.763114-28.271673 1.6963 2.827167 3.392601 6.219768 5.088901 9.046935zM749.764771 174.153506c30.533407-3.392601 55.412479 13.570403 77.464384 32.795141 58.239647 51.454445 104.605191 112.521259 129.484263 186.593043 15.266703 45.80011-11.308669 82.553285-59.935947 87.642186-7.350635 0.565433-19.224738-9.046935-22.617338-16.963004-20.921038-52.585312-39.014909-106.866924-61.066814-159.452236-18.659304-43.538377-41.276643-85.380453-63.328548-130.61513z" fill="#FFFFFF" p-id="1838"></path><path d="M450.085036 636.112645h127.787962c-2.827167 32.795141-36.753175 71.244616-61.066814 72.940917-24.313639 1.6963-60.50138-35.056875-66.721148-72.940917z" fill="#FFFFFF" p-id="1839"></path><path d="M659.295417 444.996135c-0.565433 22.051905-19.224738 39.580342-41.842076 39.014909-23.182772-0.565433-44.10381-21.486472-42.40751-42.40751 1.6963-18.659304 24.879072-40.711209 43.538377-40.145776 21.486472 0 41.276643 20.921038 40.711209 43.538377zM411.070127 484.011044c-22.051905 0.565433-41.276643-17.528437-41.276643-39.580343 0-23.182772 16.963004-41.276643 39.580343-41.842076 24.313639 0 40.145776 15.266703 40.711209 40.145776 0.565433 24.313639-14.70127 40.711209-39.014909 41.276643z" fill="" p-id="1840"></path></svg>
        </div>
      </div>
      <div class="Connect" @click="connectWebSocket">Login</div>
    </div>
    <div v-if="!isConnected" class="shadow"></div>
    <router-view></router-view> <!-- 路由匹配的视图将在这里渲染 -->
  </div>
</template>

<script setup lang="ts">
  import { ref, onUnmounted } from 'vue';
  import { Socket, io } from "socket.io-client";
  import { showDiaLog } from "@/utils";
  import { baseUrl } from "@/config";
  import { DIALOG_TYPE } from "@/enum";
  import { useRouter } from 'vue-router'
  
  const router = useRouter();

  (window as any).roomId = ref('');
  let room: any = (window as any).roomId
  let isConnected = ref(false);
  let userName = ref("");
  (window as any).socket = ref(null)

  const setName = (name: any) => {
      // const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      // let result = '';
      // for (let i = 0; i < 3; i++) {
      //     const randomIndex = Math.floor(Math.random() * characters.length);
      //     result += characters[randomIndex];
      // }
      console.log('name', name);
      userName.value = name;
      (window as any).userName = name
  };
  // (window as any).userName = setName();
  
  const connectWebSocket = () => {
    return new Promise(res => {
      if (!(window as any).roomId.value) {
        showDiaLog({ type: DIALOG_TYPE.WARNING, msg: "Please enter your username" });
        return;
      }
      if (!(window as any).userName) {
        showDiaLog({ type: DIALOG_TYPE.WARNING, msg: "Please selected your roles" });
        return;
      }
      (window as any).socket = io(baseUrl, {
        path: "/rtc",
        // query: { username: (window as any).userName, room: (window as any).roomId.value }
        query: { username: (window as any).userName + (window as any).roomId.value, room: (window as any).roomId.value }
      });
      res({});
      if (!(window as any).socket) {
        showDiaLog({ type: DIALOG_TYPE.WARNING, msg: "Please connect!" });
      } else {
        sys((window as any).socket);
      }
    });
  }

  function setConnected() {
    isConnected.value = !isConnected.value;
    showDiaLog({ type: DIALOG_TYPE.SUCCESS, msg: `Welcome ${(window as any).roomId.value} !` });
  }


  //   系统消息监听
  const sys = (socket: Socket) => {
    socket.on("connect", () => {
      console.log('-----connected!-----')
      setConnected();
    });

    socket.on('share_video', (data) => {
        console.log('Received endCalls:', data);
        if(data.user != name && data.roomId == (window as any).roomId.value) {
          router.push({
            path: '/youtube',
            query: {
              youtube: data.youtube
            }
          });
        }
    });

    socket.on('update_roles', (data) => {
        console.log('update_roles:', data);
        if(data.user != name && data.roomId == (window as any).roomId.value) {
          router.push({
            path: '/video',
            query: {
              youtube: data.youtube
            }
          });
        }
    });

    socket.on("connect_error", (data) => {
      console.log('----------------------connect_error-------',data);
      console.log('----------------------connect_error-------',data);
      console.log('----------------------connect_error-------',data);
      showDiaLog({ type: DIALOG_TYPE.ERROR, msg: data });
    });
  }

  onUnmounted(() => {
    if ((window as any).socket) {
      (window as any).socket.close();
    }
  });

</script>

<style  lang="less" scoped>
.shadow {
  background: #ddd;
  opacity: 0.65;
  position: fixed;
  left:0;
  right:0;
  top:0;
  bottom:0;
  margin: auto;
  z-index:1;
}
/* 面板样式 */
.slide-up-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  transition: transform 0.3s ease-in-out;
  transform: translateY(0%);
  padding: 20px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
  width: auto;
    /* height: 30vh; */
    z-index: 100;
    border-radius: 10px 10px 0 0;
    text-align: center;
    input {
      border: 1px solid rgb(162, 175, 185);
      border-radius: 10px;
      width: 60vw;
      height: 6vh;
      margin-top: 8vh;
      position: static;
      padding: 4px 20px;
    }
    .Connect {
      width: 70vw;
        height: 5vh;
        line-height: 5vh;
        color: #fff;
        background: #ea4c89;
        border-radius: 10px;
        margin: 10px auto 30px;
        text-align: center;
    }
}
.roles {
  // height: 20vh;
    overflow: hidden;
    padding: 20px;
    text-align: center;
    display: inline-flex;
  .li{
    width: 80px;
    height: 80px;
    float: left;
    border: 1px solid rgba(115, 130, 140, 0.25);
    border-radius: 100%;
    padding: 20px;
    margin: 10px 12px;
    svg {
      margin: 10px;
    }
  }
  .li-c{
    width: 80px;
    height: 80px;
    float: left;
    border: 2px solid #ea4c89;
    border-radius: 100%;
    padding: 20px;
    margin: 10px 12px;
    svg {
      margin: 10px;
    }
  }
}
</style>
